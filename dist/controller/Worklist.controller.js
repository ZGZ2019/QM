sap.ui.define(["egston/qm/ma/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","egston/qm/ma/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,s,o,i,r){"use strict";return e.extend("egston.qm.ma.controller.Worklist",{formatter:o,onInit:function(){this.oFilter=this.byId("filter");this.oTable=this.byId("table");this.oViewModel=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),saveAsTileTitle:this.getResourceBundle().getText("saveAsTileTitle",this.getResourceBundle().getText("worklistViewTitle")),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0,notifications:[],showDetails:false,showTable:false,showBarcode:true});this.setModel(this.oViewModel,"worklistView")},onAfterRendering:function(){this.initDefaults();$("#pic-uploader").hide();$("#pic-uploader").change(function(e){var t=e.currentTarget.files[0];this._readFile(t).done(function(e){var s=this.oViewModel.getProperty(this._sNotifUploadPath);t.raw=e;s.oPhoto=t;s._showUpload=false;s._showDelete=true;this.oViewModel.setProperty(this._sNotifUploadPath,s);$("#pic-uploader").val("")}.bind(this))}.bind(this))},_readFile:function(e){var t=new FileReader;var s=$.Deferred();t.onload=function(e){s.resolve(e.target.result)};t.onerror=function(){s.reject(this)};if(/^image/.test(e.type)){t.readAsDataURL(e)}else{t.readAsText(e)}return s.promise()},onScanPress:function(){try{window.parent.cordova.plugins.barcodeScanner.scan(function(e){if(e.cancelled){return}this.getView().byId("Aufnr").setValue("");this.getView().byId("Vornr").setValue("");var t=e.text.split("/");if(t.length!==2){sap.m.MessageBox.information(this.getResourceBundle().getText("messageBarcodeError"),{styleClass:"sapUiSizeCompact"});return}var s=t[0];var o=t[1];this.getView().byId("Aufnr").setValue(s);this.getView().byId("Vornr").setValue(o);this.onSearch()}.bind(this),function(e){sap.m.MessageBox.information(this.getResourceBundle().getText("messageBarcodeSysError"),{styleClass:"sapUiSizeCompact"})}.bind(this))}catch(e){sap.m.MessageBox.information(this.getResourceBundle().getText("messageBarcodeSysError"),{styleClass:"sapUiSizeCompact"})}},onUploadPress:function(e){this._sNotifUploadPath=e.getSource().getParent().getParent().getBindingContextPath();$("#pic-uploader").click()},onUploadDeletePress:function(e){var t=e.getSource().getParent().getParent().getBindingContextPath();var s=this.oViewModel.getProperty(t);s.oPhoto=null;s._showUpload=true;s._showDelete=false;this.oViewModel.setProperty(t,s)},initDefaults:function(){this.getView().setBusy(true);this.getOwnerComponent().getModel().metadataLoaded().then(function(){var e=this.getOwnerComponent().getModel().createKey("/DefaultSet",{id:"Default"});this.getOwnerComponent().getModel().read(e,{success:function(e){this.oNotifDefault=e;this.getView().setBusy(false)}.bind(this),error:function(e){sap.m.MessageBox.information(this.getResourceBundle().getText("messageDefaultsError"),{styleClass:"sapUiSizeCompact"});this.getView().setBusy(false)}.bind(this)})}.bind(this))},onSearch:function(e){if(this.oViewModel.getProperty("/notifications").length!==0){var t=!!this.getView().$().closest(".sapUiSizeCompact").length;sap.m.MessageBox.confirm(this.getResourceBundle().getText("messageSearchConfirm"),{styleClass:t?"sapUiSizeCompact":"",onClose:function(e){switch(e){case"OK":this.oViewModel.setProperty("/notifications",[]);this.readFauf();break;default:}}.bind(this)})}else{this.readFauf()}},readFauf:function(){this.getView().setBusy(true);var e=this.getModel().createKey("/FaufSet",{ProdOrder:this.getView().byId("Aufnr").getValue(),Vornr:this.getView().byId("Vornr").getValue()});this.getModel().read(e,{success:function(e){this.getView().setBusy(false);this.oAuftr=e;var t=this.getModel().createKey("/FaufSet",{ProdOrder:this.getView().byId("Aufnr").getValue(),Vornr:this.getView().byId("Vornr").getValue()});this.getView().byId("details").bindElement(t);this.oViewModel.setProperty("/showDetails",true);this.oViewModel.setProperty("/showTable",true)}.bind(this),error:function(e){this.oViewModel.setProperty("/showDetails",false);this.oViewModel.setProperty("/showTable",false);this.getView().setBusy(false);this.getView().byId("details").unbindElement();sap.m.MessageBox.information(this.getResourceBundle().getText("messageSearchError"),{styleClass:"sapUiSizeCompact"})}.bind(this)})},onAddNotification:function(e){var t=this.oViewModel.getProperty("/notifications");var s=this.getNotifTemplate();s.Pos=t.length+1;t.push(s);this.oViewModel.setProperty("/notifications",t)},getNotifTemplate:function(){return{Pos:"",Text:"",Ort:this.oNotifDefault.FoCodeGroup+"|"+this.oNotifDefault.Fehlerort,ArtGroup:"",Art:"",Anz:1,Klasse:this.oNotifDefault.Fehlerklasse,oPhoto:null,_showUpload:true,_showDelete:false}},onToDeleteNotification:function(e){if(this.oTable.getMode()==="None"){this.oTable.setMode("Delete")}else{this.oTable.setMode("None")}},onNotificationDelete:function(e){var t=e.getParameter("listItem");var s=t.getBindingContextPath();var o=this.oViewModel.getProperty("/notifications");var i=this.oViewModel.getProperty(s);var r=o.indexOf(i);if(r>-1){o.splice(r,1)}o.forEach(function(e,t){o[t].Pos=t+1});this.oViewModel.setProperty("/notifications",o)},onArtGroupChange:function(e){var t=e.getSource();if(!t.getSelectedItem()){t.setValueState("Error");t.setValueStateText(this.getResourceBundle().getText("messageErrorNoInput"));return}else{t.setValueState("None");t.setValueStateText("")}var s=new sap.ui.model.Filter("CodeGroup","EQ",t.getSelectedItem().getKey());e.getSource().getParent().getCells()[4].getBinding("items").filter([s])},onCancel:function(){this.oViewModel.setProperty("/notifications",[]);this.getView().byId("Aufnr").setValue("");this.getView().byId("Vornr").setValue("");this.oViewModel.setProperty("/showDetails",false);this.oViewModel.setProperty("/showTable",false)},onSave:function(){var e=this.oViewModel.getProperty("/notifications");if(e.length===0){sap.m.MessageBox.information(this.getResourceBundle().getText("messageNoData"),{styleClass:"sapUiSizeCompact"});return}var t=false;e.forEach(function(e){if(e.Art===""){sap.m.MessageBox.information(this.getResourceBundle().getText("messageEmptyArt"),{styleClass:"sapUiSizeCompact"});t=true;return}}.bind(this));if(t){return}this.oView.setBusy(true);var s=this.getModel();s.setRefreshAfterChange(false);var o={Aufnr:this.oAuftr.ProdOrder,Vornr:this.oAuftr.Vornr,Qmnum:"DUMMY",Items:[],Photos:[]};e.forEach(function(e){o.Items.push({Aufnr:this.oAuftr.ProdOrder,Vornr:this.oAuftr.Vornr,PosNr:e.Pos.toString(),Text:e.Text,LongText:e.LongText,FehlerartGroup:e.ArtGroup,Fehlerart:e.Art,Fehlerklasse:e.Klasse,FehlerOrtCodeGroup:e.Ort.split("|")[0],FehlerOrt:e.Ort.split("|")[1],Anz:parseInt(e.Anz)});if(e.oPhoto!==null&&e.oPhoto!==undefined){o.Photos.push({DocumentName:e.oPhoto.name,DocumentType:e.oPhoto.name.split(".").pop().toLowerCase(),DocumentRaw:e.oPhoto.raw.replace(/^data:image\/(png|jpeg);base64,/,"")})}},this);s.create("/NotifSet",o,{success:function(e){this.oView.setBusy(false);this.oViewModel.setProperty("/notifications",[]);this.getView().byId("Aufnr").setValue("");this.getView().byId("Vornr").setValue("");this.oViewModel.setProperty("/showDetails",false);this.oViewModel.setProperty("/showTable",false);sap.m.MessageToast.show(this.getResourceBundle().getText("messageSaveSuccess").replace("{1}",e.Qmnum))}.bind(this),error:function(e){this.oView.setBusy(false);var t=!!this.getView().$().closest(".sapUiSizeCompact").length;sap.m.MessageBox.error(JSON.parse(e.responseText).error.message.value,{styleClass:t?"sapUiSizeCompact":""})}.bind(this)})},onCreateSuccess:function(e){this.oView.setBusy(false);sap.m.MessageToast.show(this.getResourceBundle().getText("messageSuccess"))},onCreateError:function(e){this.oView.setBusy(false)},onArtChange:function(e){var t=e.getSource();if(!t.getSelectedItem()){t.setValueState("Error");t.setValueStateText(this.getResourceBundle().getText("messageErrorNoInput"));return}else{t.setValueState("None");t.setValueStateText("")}}})});
//# sourceMappingURL=Worklist.controller.js.map